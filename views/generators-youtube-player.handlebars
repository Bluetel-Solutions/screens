<style>

	#yt-player{
		position: fixed;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
	}

	#cover_card{
		background-color: #fff1e0;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
	}

	.logo {
		width: 36vmax;
		height: 36vmax;
		background: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI1NiAyNTYiPjxsaW5lYXJHcmFkaWVudCBpZD0iYSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxMjcuOTk5IiB4Mj0iMTI3Ljk5OSIgeTI9IjI1NiI+PHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjRkZFOENGIi8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjRkZEREI5Ii8+PC9saW5lYXJHcmFkaWVudD48cGF0aCBmaWxsPSJ1cmwoI2EpIiBkPSJNMCAwaDI1NnYyNTZoLTI1NnoiLz48cGF0aCBmaWxsPSIjMzMzIiBkPSJNNjUuNDcxIDEzMy42MDNjMCAxMi4wODEgMy4yMjUgMTMuNDM5IDE3LjAwMSAxMy45NTJ2NC40MjFoLTU0Ljc1NHYtNC40MjFjMTEuMzkzLS41MTMgMTQuNjIxLTEuODcxIDE0LjYyMS0xMy45NTJ2LTc4Ljg4OGMwLTEyLjA5Mi0zLjIyOS0xMy40NDktMTQuMjgxLTEzLjk1NHYtNC40MjJoOTYuNThsLjY4OCAyNS41MDVoLTQuNzYyYy00LjA4My0xMi45MjQtOC41MDctMTctMzEuMTIzLTE3aC0xNy41MTljLTUuMjYyIDAtNi40NTEgMS4xODMtNi40NTEgNS45NXYzNi41NjVoOC42MjhjMTguMDI5IDAgMjEuOTQyLTMuMjQgMjQuMTUtMTUuMzE1aDQuNDJ2NDAuODE0aC00LjQyYy0yLjM3OC0xMy42MDQtOS4xODQtMTcuMDAyLTI0LjE1LTE3LjAwMmgtOC42Mjh2MzcuNzQ3ek0yMzQuMDA3IDM2LjMzOWgtMTAxLjM0OGwtMi4zNTQgMjUuNTE0aDUuODFjMy43MTMtMTIuNDk3IDkuMTctMTcuMDA4IDIxLjM2OS0xNy4wMDhoMTQuMjg0djg4Ljc1OGMwIDEyLjA4MS0zLjIzIDEzLjQzOS0xNi4zMjMgMTMuOTUydjQuNDIxaDU1Ljc3OXYtNC40MjFjLTEzLjA5Ni0uNTEzLTE2LjMyNy0xLjg3MS0xNi4zMjctMTMuOTUydi04OC43NTloMTQuMjc4YzEyLjIwNiAwIDE3LjY2OSA0LjUxMiAyMS4zNzMgMTcuMDA4aDUuODFsLTIuMzUxLTI1LjUxM3oiLz48L3N2Zz4=);
		background-repeat: no-repeat;
		background-size: contain;
		background-position: center center;
		position: absolute;
		transform: translate(-50%, -50%);
		top: 50%;
		left: 50%;
	}

	*[data-visible=false]{
		display: none;
	}

</style>
<div class="logo"></div>


</style>
<link rel="stylesheet" href="https://build.origami.ft.com/bundles/css?modules=o-fonts@^1.6.7,o-ft-icons@^2.3.6,o-header,o-grid,o-footer,o-forms,o-colors,o-buttons" />


<div id="yt-player"></div>

<div id="cover_card" data-visible="false">
	<div class="logo"></div>
</div>

<script>

'use strict';

var player = undefined,
	bufferingTO = undefined,
	coverCard = document.getElementById('cover_card');

var playerStates = {
		"-1" : "unstarted",
		"0" : "ended",
		"1" : "playing",
		"2" : "paused",
		"3" : "buffering",
		"5" : "cued"
	};

var playerOptions = {
	width: window.innerWidth,
	height: window.innerHeight,
	events: {
		'onReady': playerReady,
		'onStateChange': playerStateChange,
		'onError' : playerError
	},
	playerVars : {
		controls : 0,
		modestbranding : 1
	}
};

function showCoverCard(){
	coverCard.setAttribute('data-visible', "true");
}

function hideCoverCard(){
	coverCard.setAttribute('data-visible', "false");
}

function checkNetworkState(){

	return new Promise(function(resolve, reject){

		var nR = new XMLHttpRequest();
		
		nR.onload = function(res){

			if(nR.status === 200){
				resolve("A-OK");
			} else {
				reject("The network test endpoint returned a status code other than 200");
			}

		};
		
		nR.ontimeout = function(){
			reject("The test request timed out");
		}

		nR.onerror = function(){
			reject("There was an error when testing the connectivity of the network");
		}

		nR.timeout = 8000;
		nR.open("GET", window.location.origin);
		nR.send();

	});

}

function destroyPlayer(){
	console.log("PLAYER DESTROYED");
	player.destroy();
}

function createPlayer(){
	console.log("PLAYER CREATED");
	player = new YT.Player('yt-player', playerOptions);
}

function onYouTubeIframeAPIReady() {
	createPlayer();
}

function playerReady(evt) {

	var listID = "{{vidID}}";

	var playListOptions = undefined;

	if(listID.length > 11){
		// This is a playlist URI.
		playListOptions = {
			list : listID
		};
	} else {
		// This is a single video URI
		playListOptions = {
			playlist : listID
		}
	}

	player.loadPlaylist(playListOptions);

}

function playerStateChange(evt){

	console.log(playerStates[evt.data]);

	console.log(player.getVideoData().title);

	if(playerStates[evt.data] === "playing"){
		hideCoverCard();
	} else if(playerStates[evt.data] === "buffering"){
	
		bufferingTO = setTimeout(function(){
			
			if(playerStates[player.getPlayerState()] === "buffering"){

				showCoverCard();
				handleNetworkIssues();

				clearTimeout(bufferingTO);
				bufferingTO = undefined;

			}

		}, 10000);
	
	} else if(bufferingTO !== undefined){
		clearTimeout(bufferingTO);
		bufferingTO = undefined;
	}

}

function handleNetworkIssues(){

	console.log("Handling network issues");

	checkNetworkState()
		.then(function(networkStatus){
			console.log(networkStatus);
			destroyPlayer();
			createPlayer();
			hideCoverCard();
		})
		.catch(function(err){
			console.error(err);
			// Fail gracefully - Check network periodically
		
			setTimeout(function(){

				handleNetworkIssues();

			}, 20000);

		})
	;

}

function playerError(error){

	var errCode = error.data;

	var errors = {
		"-1" : {
			shortReason : "unstarted",
			longReason : "Something has gone wrong with the player. It likely can't access the video resource on the network"
		},
		"2" : {
			shortReason : "invalidparameter",
			longReason : "The request contains an invalid parameter value."
		},
		"5" : {
			shortReason : "html-error",
			longReason : "The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred."
		},
		"100" : {
			shortReason : "no-video",
			longReason : "This error occurs when a video has been removed (for any reason) or has been marked as private."
		},
		"101" : {
			shortReason : "no-embed",
			longReason : "The owner of the requested video does not allow it to be played in embedded players."
		},
		"105" : {
			shortReason : "no-embed",
			longReason : "The owner of the requested video does not allow it to be played in embedded players."
		}
	
	}

	if (errors[errCode].shortReason === "html-error" || errors[errCode].shortReason === "unstarted"){

		console.log(errors[errCode].longReason);

		//Check network status, if connected -> restart - if not -> handle gracefully, alert admin 

		showCoverCard();
		handleNetworkIssues();

	}

}

document.title = "FT Screens || Youtube Generator";

</script>

<script src="https://www.youtube.com/iframe_api"></script>

